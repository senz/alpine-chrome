---

name: cleanup-old-images
on:
  schedule:
    # Запуск каждое воскресенье в 03:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      keep_count:
        description: 'Number of recent tagged versions to keep per tag type'
        required: false
        default: '10'
      dry_run:
        description: 'Dry run (do not delete, just list)'
        required: false
        default: 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Cleanup old image tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP_COUNT: ${{ github.event.inputs.keep_count || 10 }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          PACKAGE_NAME: alpine-chrome
          OWNER: senz
        run: |
          echo "Cleaning up old tags for package: ${PACKAGE_NAME}"
          echo "Keeping last ${KEEP_COUNT} versions with build ID"
          echo "Dry run: ${DRY_RUN}"
          echo ""

          # Получаем все версии пакета
          VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100" \
            --paginate \
            --jq '.[] | select(.metadata.container.tags | length > 0) | {id: .id, tags: .metadata.container.tags, created_at: .created_at}')

          # Обрабатываем каждый тип тега отдельно
          TAG_PATTERNS=("^[0-9]+-[0-9]+$" "^[0-9]+-[0-9]+-with-node$" "^[0-9]+-[0-9]+-with-deno$" "^[0-9]+-[0-9]+-with-chromedriver$" "^[0-9]+-[0-9]+-with-playwright$" "^[0-9]+-[0-9]+-with-puppeteer$" "^[0-9]+-[0-9]+-with-puppeteer-xvfb$" "^[0-9]+-[0-9]+-with-selenoid$")

          for PATTERN in "${TAG_PATTERNS[@]}"; do
            echo "Processing pattern: ${PATTERN}"

            # Находим ID версий, соответствующих паттерну, сортируем по дате (новые первые)
            VERSION_IDS=$(echo "$VERSIONS" | jq -r --arg pattern "$PATTERN" '
              select(.tags[] | test($pattern)) | .id' | sort -rn)

            if [ -z "$VERSION_IDS" ]; then
              echo "  No versions found for pattern ${PATTERN}"
              continue
            fi

            TOTAL=$(echo "$VERSION_IDS" | wc -l)
            echo "  Found ${TOTAL} versions matching pattern"

            if [ "$TOTAL" -le "$KEEP_COUNT" ]; then
              echo "  Keeping all ${TOTAL} versions (less than ${KEEP_COUNT})"
              continue
            fi

            # Пропускаем первые KEEP_COUNT версий, удаляем остальные
            TO_DELETE=$(echo "$VERSION_IDS" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "  Keeping ${KEEP_COUNT} newest versions"
            echo "  Deleting ${DELETE_COUNT} old versions"

            for VERSION_ID in $TO_DELETE; do
              VERSION_INFO=$(echo "$VERSIONS" | jq -r --arg id "$VERSION_ID" 'select(.id == ($id | tonumber))')
              TAGS=$(echo "$VERSION_INFO" | jq -r '.tags | join(", ")')
              CREATED=$(echo "$VERSION_INFO" | jq -r '.created_at')

              if [ "$DRY_RUN" == "true" ]; then
                echo "  [DRY RUN] Would delete version ID: ${VERSION_ID} (tags: ${TAGS}, created: ${CREATED})"
              else
                echo "  Deleting version ID: ${VERSION_ID} (tags: ${TAGS}, created: ${CREATED})"
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}" || echo "  Failed to delete version ${VERSION_ID}"
              fi
            done
            echo ""
          done

          echo "Cleanup completed!"
